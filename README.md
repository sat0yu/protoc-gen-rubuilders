# protoc-gen-rubuilders
Follow the dogma "Only take the elements you need, ignore anything you don't."

The protocol buffer compiler [generates ruby codes from `.proto` files with a Ruby plugin.](https://grpc.io/docs/tutorials/basic/ruby/)  
However, the generated codes look not so good because `.new` method in each message class disallows unknown fields and raises `ArgumentError`.  
It is such a hassle to filter all unknown fields for generating a serializable object 🤔

```sh
irb(main):001:0> load 'example/addressbook_pb.rb'
=> true

irb(main):002:0> Tutorial::Person.new
=> <Tutorial::Person: name: "", id: 0, email: "", phones: [], last_updated: nil>

# Undefined keys cause `ArgumentError`
irb(main):003:0> Tutorial::Person.new(id: 1, unknown_key: "value")
Traceback (most recent call last):
        3: from (irb):9
        2: from (irb):9:in `new'
        1: from (irb):9:in `initialize'
ArgumentError (Unknown field name 'unknown_key' in initialization map entry.)
```

`Rubuilder` provides a factory method `.build` which automatically filters unknown keys. 🏭
```sh
irb(main):001:0> load 'example/addressbook_pb.rb'
=> true

irb(main):002:0> load 'example/addressbook_pb_builder.rb'
=> true

# `.build` method ignores unknown keys
irb(main):003:0> Tutorial::Person.build(id: 1, unknown_key: "value")
=> <Tutorial::Person: name: "", id: 1, email: "", phones: [], last_updated: nil>
```

## Install
```sh
GO111MODULE=off go get github.com/sat0yu/protoc-gen-rubuilders/cmd/protoc-gen-rubuilders
```

## Usage
```sh
grpc_tools_ruby_protoc -I. --plugin=./protoc-gen-rubuilders --ruby_out=. --rubuilders_out=. */**.proto
```

The generated files look like this
```ruby
# Generated by the protocol buffer compiler.  DO NOT EDIT!
# source: example/addressbook.proto

 module Tutorial
   class Person
     def self.build(**kwargs)
       attributes = kwargs.select{|k, _| %i(name id email phones last_updated ).include? k}
       self.new(attributes)
     end
   end
 end

 module Tutorial
   class Person
     class PhoneNumber
       def self.build(**kwargs)
         attributes = kwargs.select{|k, _| %i(number type ).include? k}
         self.new(attributes)
       end
     end
   end
 end

 module Tutorial
   class AddressBook
     def self.build(**kwargs)
       attributes = kwargs.select{|k, _| %i(people ).include? k}
       self.new(attributes)
     end
   end
 end
```

Now that `.build` method is available 🎉
```sh
irb(main):001:0> load 'example/addressbook_pb.rb'
=> true

irb(main):002:0> load 'example/addressbook_pb_builder.rb'
=> true

# `.build` method ignores unknown keys
irb(main):003:0> Tutorial::Person.build(id: 1, unknown_key: "value")
=> <Tutorial::Person: name: "", id: 1, email: "", phones: [], last_updated: nil>
```
